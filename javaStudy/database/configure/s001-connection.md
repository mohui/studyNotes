# sql 配置
## 线程，数据库连接，事务之间的关系

### Java中事务控制的基本单位:Connection
- 在java中API中，使用java.sql.Connection的实例，表示和数据库的一个连接，底层是采用TCP/IP方式进行连接。
- 连接后，可以通过操作此Connection实例，来进行事务控制。

>思考:既然Connection实例能进行事务控制，那我们直接代码中创建并使用它可以吗? 
> 然而事实上，我们并不能这么做，因为Connection和数据库有非常紧密的关系，数据库所在的系统资源是非常有限的。

### 有限的系统资源-----决定java.sql.Connection连接个数 
- 应用程序和数据库之间建立连接，则数据库所在机器也会为此连接分配一定线程资源维护这个连接
- (客户端登 录建立连接成功，数据库一方会保存此次会话连接信息默认保留8小时)如果连接数越多，消耗数据库所在机 器的线程资源就越多。
- 不同的连接，可能会操作相同的表数据，出现高并发操作，所以数据库为了对ACID特性的支持(加锁:行锁， 表锁)，又会牺牲更多的资源。
> 综上，建立一个连接，会消耗数据库所在机器的一些资源，而这些资源是系统比较宝贵的有限资源，
> 所以这些资源，就限制了数据库所能创建出的连接数和处理性能，当应用程序有数据库连接需求非常非常大时，
> 很容易会达到数据库的连接并发瓶颈。

| 资源              | 说明                                                            |
|-----------------|---------------------------------------------------------------|
| 线程数             | 线程越多，线程的上下文切换会越频繁，会影响其处理能力                                    |
| 创建Connection的开销 | 由于Connection负责和数据库之间的通信，在创建环节会做大量的初始化 ，创建过程所需时间和内存资源上都有一定的开销  |
| 内存资源            | 为了维护Connection对象会消耗一定的内存                                      |
| 锁占用             | 在高并发模式下，不同的Connection可能会操作相同的表数据，就会存在锁的情况，数据库为了维护这种锁会有不少的内存开销 |

## 数据库设置的最多支持多少个Connection连接?
```markdown
查看当前数据库最多支持多少数据库连接
show variables like '%max_connections%';
设置当前运行时mysql的最大连接数，服务重启连接数将还原 set GLOBAL max_connections = 200;
修改 my.ini 或者my.cnf 配置文件 max_connections = 200;
```
```html
思考:数据库连接数设置越大越好吗? 
不是的，连接数越大，数据库所在操作系统需使用大量线程维护，而且会伴随着线程上下文的切换，
并且连接数越多，操作同一张表的同一条数据的概率更大，反而导致整体数据库性能下降，所以具体连接数的大小设置，根据具体业务场景来调优。
```

### java.sql.Connection实例的特性
- 一个Connection实例中，在操作的时序上，事务和事务之间的执行是线性排开依次串行执行的。
> 说白了，一个连接上的多个事务必须是线性的(序列化的事务操作模式)，一个新事务的开启，必须在上 一个事务完成之后(如果存在的话)。
- 而一个事务内是可以不限次数的SQL语句。
- Connection实例是基于TCP/IP协议的，所以在初始化建立连接之后，手动关闭之前，是会和数据库保持心跳存活连接，
- 所以可以使用Connection实例执行不限次数的SQL语句请求，包括事务请求。
- 数据库连接池就是基于此特性建立的。
- 对于Connection 对象而言, 在执行过commit 或 rollback时, 表示事务完成, 将会为后续的操作开启新的事务